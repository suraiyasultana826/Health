<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Appointments</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/scripts.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .appointment-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .appointment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.25);
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            border-left: 3px solid #e5e7eb;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3b82f6;
        }
        .status-badge {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen font-sans">
    {% include 'navbar.html' %}
    
    <div class="container mx-auto p-8 max-w-7xl">
        <!-- Hero Section -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 mb-4">
                <i class="fas fa-calendar-check mr-3"></i>Appointment Management
            </h1>
            <p class="text-xl text-gray-600">Track and manage all scheduled appointments</p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold mb-1">Total Appointments</p>
                        <h3 class="text-4xl font-bold text-gray-800" id="total-appointments-stat">0</h3>
                    </div>
                    <div class="bg-blue-100 rounded-full p-4">
                        <i class="fas fa-calendar-alt text-3xl text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold mb-1">Today</p>
                        <h3 class="text-4xl font-bold text-green-600" id="today-appointments">0</h3>
                    </div>
                    <div class="bg-green-100 rounded-full p-4">
                        <i class="fas fa-calendar-day text-3xl text-green-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold mb-1">Upcoming</p>
                        <h3 class="text-4xl font-bold text-purple-600" id="upcoming-appointments">0</h3>
                    </div>
                    <div class="bg-purple-100 rounded-full p-4">
                        <i class="fas fa-clock text-3xl text-purple-600"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-pink-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm font-semibold mb-1">This Week</p>
                        <h3 class="text-4xl font-bold text-pink-600" id="week-appointments">0</h3>
                    </div>
                    <div class="bg-pink-100 rounded-full p-4">
                        <i class="fas fa-calendar-week text-3xl text-pink-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedback-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div id="modal-message" class="p-6 rounded-lg shadow-lg max-w-md w-full">
                <button onclick="closeModal()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full">Close</button>
            </div>
        </div>

        <!-- Add Appointment Modal -->
        <div id="add-appointments-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl w-full transform transition-all">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-calendar-plus mr-3 text-blue-600"></i>Schedule New Appointment
                </h2>
                <form id="add-appointments-form" onsubmit="submitForm(event, '/appointments/', 'add-appointments-form', 'Appointment')">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-user-injured mr-2"></i>Patient
                            </label>
                            <select name="patient_id" id="add-patient-select" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" required>
                                <option value="">Select Patient...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-clock mr-2"></i>Available Slot
                            </label>
                            <select name="slot_id" id="add-slot-select" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition" required>
                                <option value="">Select Slot...</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-8">
                        <button type="button" onclick="closeAddModal('appointments')" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Cancel
                        </button>
                        <button type="submit" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 transition font-semibold shadow-lg">
                            <i class="fas fa-save mr-2"></i>Schedule Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Appointment Modal -->
        <div id="edit-appointments-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-2xl w-full transform transition-all">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-edit mr-3 text-purple-600"></i>Edit Appointment
                </h2>
                <form id="edit-appointments-form" onsubmit="submitForm(event, '/appointments/update', 'edit-appointments-form', 'Appointment')">
                    <input type="hidden" name="appointment_id" id="edit-appointments-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-user-injured mr-2"></i>Patient
                            </label>
                            <select name="patient_id" id="edit-appointments-patient-id" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition" required>
                                <option value="">Select Patient...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">
                                <i class="fas fa-clock mr-2"></i>Available Slot
                            </label>
                            <select name="slot_id" id="edit-appointments-slot-id" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 transition" required>
                                <option value="">Select Slot...</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-8">
                        <button type="button" onclick="closeEditModal('appointments')" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Cancel
                        </button>
                        <button type="submit" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition font-semibold shadow-lg">
                            <i class="fas fa-save mr-2"></i>Update Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Filters and Actions -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-6">
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        <i class="fas fa-search mr-2"></i>Search Appointments
                    </label>
                    <input 
                        type="text" 
                        id="search-appointments" 
                        class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition shadow-sm" 
                        placeholder="Search by patient or doctor..."
                        oninput="filterAppointments()"
                    >
                </div>

                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        <i class="fas fa-filter mr-2"></i>Filter by Date
                    </label>
                    <select 
                        id="date-filter" 
                        class="w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition shadow-sm"
                        onchange="filterAppointments()"
                    >
                        <option value="all">All Dates</option>
                        <option value="today">Today</option>
                        <option value="tomorrow">Tomorrow</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="past">Past</option>
                        <option value="upcoming">Upcoming</option>
                    </select>
                </div>

                <div class="flex items-end space-x-3">
                    <button 
                        onclick="openAddModal('appointments')" 
                        class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-lg hover:from-blue-700 hover:to-purple-700 transition font-semibold shadow-lg"
                    >
                        <i class="fas fa-plus mr-2"></i>New Appointment
                    </button>
                </div>
            </div>

            <div class="flex items-center justify-between text-sm text-gray-600">
                <span id="appointment-count">Showing 0 appointments</span>
                <div class="flex space-x-4">
                    <button onclick="exportAppointments()" class="text-blue-600 hover:text-blue-800 font-semibold">
                        <i class="fas fa-download mr-1"></i>Export
                    </button>
                    <button onclick="printAppointments()" class="text-purple-600 hover:text-purple-800 font-semibold">
                        <i class="fas fa-print mr-1"></i>Print
                    </button>
                </div>
            </div>
        </div>

        <!-- Today's Appointments Highlight -->
        <div class="bg-gradient-to-r from-green-500 to-teal-600 rounded-2xl shadow-xl p-8 mb-8 text-white">
            <h2 class="text-3xl font-bold mb-6 flex items-center">
                <i class="fas fa-calendar-day mr-3"></i>Today's Schedule
            </h2>
            <div id="today-schedule" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Today's appointments will be inserted here -->
            </div>
        </div>

        <!-- Appointments Timeline -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-list-ul mr-3 text-blue-600"></i>All Appointments
            </h2>
            <div id="appointments-container" class="space-y-4">
                <!-- Appointment cards will be inserted here -->
            </div>
            <div id="no-appointments" class="hidden text-center py-12">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                <p class="text-xl text-gray-600">No appointments found</p>
            </div>
        </div>
    </div>

    <script>
        let allAppointments = [];
        let allPatients = [];
        let allSlots = [];
        let allDoctors = [];

        // Load all data
        async function loadAllData() {
            try {
                const [appointments, patients, slots, doctors] = await Promise.all([
                    fetch('/appointments/list').then(r => r.json()),
                    fetch('/patients/list').then(r => r.json()),
                    fetch('/appointment_slots/list').then(r => r.json()),
                    fetch('/doctors/list').then(r => r.json())
                ]);

                allAppointments = appointments;
                allPatients = patients;
                allSlots = slots;
                allDoctors = doctors;

                updateStatistics();
                populateSelects();
                displayAppointments(allAppointments);
                displayTodaySchedule();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('total-appointments-stat').textContent = allAppointments.length;

            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = allAppointments.filter(apt => {
                const slot = allSlots.find(s => s.id === apt.slot_id);
                return slot && slot.date === today;
            });
            document.getElementById('today-appointments').textContent = todayAppointments.length;

            const now = new Date();
            const upcoming = allAppointments.filter(apt => {
                const slot = allSlots.find(s => s.id === apt.slot_id);
                return slot && new Date(slot.date) > now;
            });
            document.getElementById('upcoming-appointments').textContent = upcoming.length;

            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const thisWeek = allAppointments.filter(apt => {
                const slot = allSlots.find(s => s.id === apt.slot_id);
                if (!slot) return false;
                const slotDate = new Date(slot.date);
                return slotDate >= now && slotDate <= weekFromNow;
            });
            document.getElementById('week-appointments').textContent = thisWeek.length;
        }

        // Populate select dropdowns
        function populateSelects() {
            // Populate patient selects
            const addPatientSelect = document.getElementById('add-patient-select');
            const editPatientSelect = document.getElementById('edit-appointments-patient-id');
            
            const patientOptions = allPatients.map(p => 
                `<option value="${p.id}">${p.name} (${p.email})</option>`
            ).join('');
            
            addPatientSelect.innerHTML = '<option value="">Select Patient...</option>' + patientOptions;
            editPatientSelect.innerHTML = '<option value="">Select Patient...</option>' + patientOptions;

            // Populate slot selects with available slots only
            const addSlotSelect = document.getElementById('add-slot-select');
            const editSlotSelect = document.getElementById('edit-appointments-slot-id');
            
            const availableSlots = allSlots.filter(s => s.is_available);
            const slotOptions = availableSlots.map(s => {
                const doctor = allDoctors.find(d => d.id === s.doctor_id);
                return `<option value="${s.id}">${s.date} ${s.start_time.substring(0, 5)} - ${doctor ? doctor.name : 'Unknown'}</option>`;
            }).join('');
            
            addSlotSelect.innerHTML = '<option value="">Select Slot...</option>' + slotOptions;
            editSlotSelect.innerHTML = '<option value="">Select Slot...</option>' + slotOptions;
        }

        // Display today's schedule
        function displayTodaySchedule() {
            const container = document.getElementById('today-schedule');
            const today = new Date().toISOString().split('T')[0];
            
            const todayAppointments = allAppointments
                .map(apt => {
                    const slot = allSlots.find(s => s.id === apt.slot_id);
                    const patient = allPatients.find(p => p.id === apt.patient_id);
                    const doctor = slot ? allDoctors.find(d => d.id === slot.doctor_id) : null;
                    return { ...apt, slot, patient, doctor };
                })
                .filter(apt => apt.slot && apt.slot.date === today)
                .sort((a, b) => a.slot.start_time.localeCompare(b.slot.start_time));

            if (todayAppointments.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <i class="fas fa-calendar-check text-6xl mb-4 opacity-50"></i>
                        <p class="text-xl">No appointments scheduled for today</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = todayAppointments.map(apt => `
                <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-xl p-4 border-2 border-white border-opacity-30">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-2xl font-bold">${apt.slot.start_time.substring(0, 5)}</span>
                        <span class="bg-white bg-opacity-30 px-3 py-1 rounded-full text-sm font-semibold status-badge">
                            <i class="fas fa-circle text-green-400 mr-1"></i>Active
                        </span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <p class="flex items-center">
                            <i class="fas fa-user-injured w-5 mr-2"></i>
                            <strong>${apt.patient ? apt.patient.name : 'Unknown'}</strong>
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-user-md w-5 mr-2"></i>
                            ${apt.doctor ? apt.doctor.name : 'Unknown'}
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-stethoscope w-5 mr-2"></i>
                            ${apt.doctor ? apt.doctor.specialty : 'N/A'}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Display appointments
        function displayAppointments(appointments) {
            const container = document.getElementById('appointments-container');
            const noAppointments = document.getElementById('no-appointments');
            const appointmentCount = document.getElementById('appointment-count');

            if (appointments.length === 0) {
                container.innerHTML = '';
                noAppointments.classList.remove('hidden');
                appointmentCount.textContent = 'Showing 0 appointments';
                return;
            }

            noAppointments.classList.add('hidden');
            appointmentCount.textContent = `Showing ${appointments.length} appointment${appointments.length > 1 ? 's' : ''}`;

            const enrichedAppointments = appointments.map(apt => {
                const slot = allSlots.find(s => s.id === apt.slot_id);
                const patient = allPatients.find(p => p.id === apt.patient_id);
                const doctor = slot ? allDoctors.find(d => d.id === slot.doctor_id) : null;
                return { ...apt, slot, patient, doctor };
            }).sort((a, b) => {
                if (!a.slot || !b.slot) return 0;
                const dateCompare = b.slot.date.localeCompare(a.slot.date);
                if (dateCompare !== 0) return dateCompare;
                return b.slot.start_time.localeCompare(a.slot.start_time);
            });

            container.innerHTML = enrichedAppointments.map((apt, index) => {
                const isPast = apt.slot && new Date(apt.slot.date) < new Date();
                const statusColor = isPast ? 'bg-gray-100 border-gray-300' : 'bg-blue-50 border-blue-200';
                const statusBadge = isPast ? 
                    '<span class="bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-semibold"><i class="fas fa-check mr-1"></i>Completed</span>' :
                    '<span class="bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm font-semibold"><i class="fas fa-clock mr-1"></i>Upcoming</span>';

                return `
                    <div class="appointment-card ${statusColor} border-2 rounded-xl p-6 fade-in-up" style="animation-delay: ${index * 0.05}s" data-search="${apt.patient?.name.toLowerCase()} ${apt.doctor?.name.toLowerCase()}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-4">
                                    <div>
                                        <span class="text-sm text-gray-600 font-semibold">Appointment #${apt.id}</span>
                                        ${statusBadge}
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <div class="bg-blue-500 rounded-full w-10 h-10 flex items-center justify-center text-white mr-3">
                                                <i class="fas fa-user-injured"></i>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-600">Patient</p>
                                                <p class="font-bold text-gray-800">${apt.patient ? apt.patient.name : 'Unknown Patient'}</p>
                                                <p class="text-xs text-gray-600">${apt.patient ? apt.patient.email : 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <div class="bg-purple-500 rounded-full w-10 h-10 flex items-center justify-center text-white mr-3">
                                                <i class="fas fa-user-md"></i>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-600">Doctor</p>
                                                <p class="font-bold text-gray-800">${apt.doctor ? apt.doctor.name : 'Unknown Doctor'}</p>
                                                <p class="text-xs text-gray-600">${apt.doctor ? apt.doctor.specialty : 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                                    <div class="bg-white bg-opacity-50 rounded-lg p-3">
                                        <i class="fas fa-calendar text-blue-600 mb-1"></i>
                                        <p class="text-xs text-gray-600">Date</p>
                                        <p class="font-semibold text-gray-800">${apt.slot ? apt.slot.date : 'N/A'}</p>
                                    </div>
                                    <div class="bg-white bg-opacity-50 rounded-lg p-3">
                                        <i class="fas fa-clock text-green-600 mb-1"></i>
                                        <p class="text-xs text-gray-600">Time</p>
                                        <p class="font-semibold text-gray-800">${apt.slot ? apt.slot.start_time.substring(0, 5) : 'N/A'}</p>
                                    </div>
                                    <div class="bg-white bg-opacity-50 rounded-lg p-3">
                                        <i class="fas fa-hourglass-end text-orange-600 mb-1"></i>
                                        <p class="text-xs text-gray-600">Duration</p>
                                        <p class="font-semibold text-gray-800">30 min</p>
                                    </div>
                                    <div class="bg-white bg-opacity-50 rounded-lg p-3">
                                        <i class="fas fa-bookmark text-pink-600 mb-1"></i>
                                        <p class="text-xs text-gray-600">Booked</p>
                                        <p class="font-semibold text-gray-800">${new Date(apt.booked_at).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex md:flex-col gap-2">
                                <button onclick="openEditModal('appointments', ${apt.id}, ${apt.patient_id}, ${apt.slot_id})" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-md flex-1 md:flex-none">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                                <button onclick="cancelAppointment(${apt.id}, ${apt.slot_id})" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition font-semibold shadow-md flex-1 md:flex-none">
                                    <i class="fas fa-times mr-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Cancel appointment and release slot
        async function cancelAppointment(appointmentId, slotId) {
            if (!confirm('Are you sure you want to cancel this appointment? The time slot will become available again.')) {
                return;
            }

            try {
                // First, delete the appointment
                const formData = new FormData();
                formData.append('appointment_id', appointmentId);

                const deleteResponse = await fetch('/appointments/delete', {
                    method: 'POST',
                    body: formData
                });

                if (!deleteResponse.ok) {
                    throw new Error('Failed to delete appointment');
                }

                // Then, make the slot available again
                const slot = allSlots.find(s => s.id === slotId);
                if (slot) {
                    const slotFormData = new FormData();
                    slotFormData.append('slot_id', slotId);
                    slotFormData.append('doctor_id', slot.doctor_id);
                    slotFormData.append('date', slot.date);
                    slotFormData.append('start_time', slot.start_time);
                    slotFormData.append('end_time', slot.end_time);
                    slotFormData.append('is_available', 'true');

                    const updateResponse = await fetch('/appointment_slots/update', {
                        method: 'POST',
                        body: slotFormData
                    });

                    if (!updateResponse.ok) {
                        throw new Error('Failed to release slot');
                    }
                }

                showModal('Appointment cancelled successfully! The time slot is now available.', 'success');
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                showModal('Error cancelling appointment: ' + error.message, 'error');
            }
        }

        // Filter appointments
        function filterAppointments() {
            const searchValue = document.getElementById('search-appointments').value.toLowerCase();
            const dateFilter = document.getElementById('date-filter').value;

            let filtered = [...allAppointments];

            // Apply search filter
            if (searchValue) {
                filtered = filtered.filter(apt => {
                    const patient = allPatients.find(p => p.id === apt.patient_id);
                    const slot = allSlots.find(s => s.id === apt.slot_id);
                    const doctor = slot ? allDoctors.find(d => d.id === slot.doctor_id) : null;
                    
                    const patientMatch = patient && patient.name.toLowerCase().includes(searchValue);
                    const doctorMatch = doctor && doctor.name.toLowerCase().includes(searchValue);
                    
                    return patientMatch || doctorMatch;
                });
            }

            // Apply date filter
            if (dateFilter !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const weekFromNow = new Date(today);
                weekFromNow.setDate(weekFromNow.getDate() + 7);
                const monthFromNow = new Date(today);
                monthFromNow.setMonth(monthFromNow.getMonth() + 1);

                filtered = filtered.filter(apt => {
                    const slot = allSlots.find(s => s.id === apt.slot_id);
                    if (!slot) return false;
                    
                    const slotDate = new Date(slot.date);
                    slotDate.setHours(0, 0, 0, 0);

                    switch(dateFilter) {
                        case 'today':
                            return slotDate.getTime() === today.getTime();
                        case 'tomorrow':
                            return slotDate.getTime() === tomorrow.getTime();
                        case 'week':
                            return slotDate >= today && slotDate <= weekFromNow;
                        case 'month':
                            return slotDate >= today && slotDate <= monthFromNow;
                        case 'past':
                            return slotDate < today;
                        case 'upcoming':
                            return slotDate >= today;
                        default:
                            return true;
                    }
                });
            }

            displayAppointments(filtered);
        }

        // Export appointments
        function exportAppointments() {
            const csv = [
                ['ID', 'Patient', 'Doctor', 'Specialty', 'Date', 'Time', 'Booked At'].join(','),
                ...allAppointments.map(apt => {
                    const slot = allSlots.find(s => s.id === apt.slot_id);
                    const patient = allPatients.find(p => p.id === apt.patient_id);
                    const doctor = slot ? allDoctors.find(d => d.id === slot.doctor_id) : null;
                    
                    return [
                        apt.id,
                        patient ? patient.name : 'Unknown',
                        doctor ? doctor.name : 'Unknown',
                        doctor ? doctor.specialty : 'N/A',
                        slot ? slot.date : 'N/A',
                        slot ? slot.start_time : 'N/A',
                        new Date(apt.booked_at).toLocaleString()
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `appointments_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // Print appointments
        function printAppointments() {
            window.print();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            
            // Refresh every 30 seconds
            setInterval(loadAllData, 30000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('search-appointments').focus();
            }
            
            // Ctrl/Cmd + N to add new appointment
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                openAddModal('appointments');
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                closeAddModal('appointments');
                closeEditModal('appointments');
            }
        });
    </script>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #appointments-container, #appointments-container * {
                visibility: visible;
            }
            #appointments-container {
                position: absolute;
                left: 0;
                top: 0;
            }
            .appointment-card {
                page-break-inside: avoid;
            }
        }
    </style>
</body>
</html>